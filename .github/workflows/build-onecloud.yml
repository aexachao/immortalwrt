name: Build ImmortalWrt for OneCloud (Production Ready)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
      run: |
        echo "é‡Šæ”¾ç£ç›˜ç©ºé—´å‰ï¼š"
        df -h
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        echo "é‡Šæ”¾ç£ç›˜ç©ºé—´åï¼š"
        df -h

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo apt-get update
        
        # åˆ†æ‰¹å®‰è£…ï¼Œé¿å…ä¾èµ–å†²çª
        echo "å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·..."
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-dev python3-distutils \
          python3-setuptools rsync unzip wget libz-dev
        
        echo "å®‰è£…é¢å¤–ä¾èµ–..."
        sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint \
          binutils bison bzip2 cmake cpio curl device-tree-compiler flex gperf \
          haveged help2man intltool libc6-dev-i386 libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libpython3-dev \
          libreadline-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full \
          patch pkgconf python3-pyelftools qemu-utils scons squashfs-tools \
          subversion swig texinfo uglifyjs upx-ucl vim xmlto xxd zlib1g-dev
        
        echo "å®‰è£…æ–‡ä»¶ç³»ç»Ÿå·¥å…·..."
        sudo apt-get install -y dosfstools mtools parted
        
        echo "è®¾ç½®æ—¶åŒº..."
        sudo timedatectl set-timezone "$TZ"
        
        echo "éªŒè¯å…³é”®å·¥å…·..."
        gcc --version
        python3 --version
        docker --version

    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

    - name: æ›´æ–° feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        cd $OPENWRT_PATH
        
        cat > .config <<EOF
        # ç›®æ ‡å¹³å°ï¼šARMv7ï¼ˆç©å®¢äº‘ S805 åŸºäº ARMv8 æ¶æ„ä½†ä»…æ”¯æŒ 32 ä½æ¨¡å¼ï¼‰
        CONFIG_TARGET_armsr=y
        CONFIG_TARGET_armsr_armv7=y
        CONFIG_TARGET_MULTI_PROFILE=y
        CONFIG_TARGET_DEVICE_armsr_armv7_DEVICE_generic=y
        
        # ç”Ÿæˆ rootfs.tar.gzï¼ˆå¿…é¡»ï¼ï¼‰
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=960
        
        # æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_EXT4_JOURNAL=y
        
        # å†…æ ¸æ¨¡å—
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        CONFIG_PACKAGE_kmod-usb-storage-extras=y
        CONFIG_PACKAGE_kmod-usb-storage-uas=y
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        CONFIG_PACKAGE_kmod-fs-ntfs3=y
        
        # åŸºç¡€ç³»ç»Ÿ
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        
        # æ ¸å¿ƒåº”ç”¨
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        
        # ç½‘ç»œå·¥å…·
        CONFIG_PACKAGE_wget-ssl=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_ethtool=y
        
        # ç³»ç»Ÿå·¥å…·
        CONFIG_PACKAGE_htop=y
        CONFIG_PACKAGE_bash=y
        CONFIG_PACKAGE_tar=y
        CONFIG_PACKAGE_gzip=y
        
        EOF
        
        make defconfig
        
        echo "===== é…ç½®é¢„è§ˆ ====="
        grep "^CONFIG_TARGET" .config | head -10

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $OPENWRT_PATH
        make download -j16
        find dl -size -1024c -exec rm -f {} \;

    - name: éªŒè¯é…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
      run: |
        cd $OPENWRT_PATH
        echo "===== æ£€æŸ¥ç›®æ ‡å¹³å° ====="
        ls -la target/linux/ | grep armsr || echo "æœªæ‰¾åˆ° armsr ç›®æ ‡"
        
        echo "===== å½“å‰é…ç½® ====="
        grep "^CONFIG_TARGET" .config
        
        echo "===== å¯ç”¨æ¶æ„ ====="
        find target/linux -maxdepth 1 -type d | sort

    - name: ç¼–è¯‘ ImmortalWrt
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ç¼–è¯‘ï¼ˆ$(nproc) çº¿ç¨‹ï¼‰..."
        echo "ç¼–è¯‘å¼€å§‹: $(date)"
        
        make -j$(nproc) V=s 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee -a build.log
        
        echo "ç¼–è¯‘ç»“æŸ: $(date)"
        
        # æ£€æŸ¥æ˜¯å¦ç¼–è¯‘æˆåŠŸ
        if [ -f "bin/targets/armsr/armv7/immortalwrt-armsr-armv7-generic-rootfs.tar.gz" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "ç¼–è¯‘å¤±è´¥ï¼šæœªæ‰¾åˆ° rootfs.tar.gz"
          exit 1
        fi

    - name: æ£€æŸ¥ç¼–è¯‘äº§ç‰©
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH
        echo "===== ç¼–è¯‘äº§ç‰© ====="
        find bin/targets -type f -name "*.tar.gz" -o -name "*.img.gz" | sort
        
        echo ""
        echo "===== æŸ¥æ‰¾ rootfs.tar.gz ====="
        ROOTFS=$(find bin/targets -name "*rootfs.tar.gz" 2>/dev/null | head -n 1)
        
        if [ -z "$ROOTFS" ]; then
          echo "âš ï¸  æœªæ‰¾åˆ° rootfs.tar.gz æ–‡ä»¶"
          echo "å¯ç”¨çš„æ–‡ä»¶ï¼š"
          ls -lh bin/targets/armsr/armv7/
          
          # å°è¯•ä½¿ç”¨ ext4 rootfs ä½œä¸ºæ›¿ä»£
          ROOTFS=$(find bin/targets -name "*ext4-rootfs.img.gz" | head -n 1)
          if [ -n "$ROOTFS" ]; then
            echo "âœ… æ‰¾åˆ°æ›¿ä»£æ–‡ä»¶: $ROOTFS"
            echo "å°†ä½¿ç”¨æ­¤æ–‡ä»¶è¿›è¡Œæ‰“åŒ…"
          else
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•å¯ç”¨çš„ rootfs æ–‡ä»¶"
            exit 1
          fi
        else
          echo "âœ… æ‰¾åˆ° rootfs: $ROOTFS"
        fi
        
        ls -lh "$ROOTFS"
        echo "ROOTFS_PATH=$ROOTFS" >> $GITHUB_ENV

    - name: å‡†å¤‡æ‰“åŒ…ç¯å¢ƒ
      if: steps.compile.outputs.status == 'success'
      run: |
        mkdir -p $GITHUB_WORKSPACE/package
        cd $GITHUB_WORKSPACE/package
        
        # å…‹éš† soulteary çš„ u-boot é¡¹ç›®
        echo "ä¸‹è½½ OneCloud u-boot å·¥å…·..."
        git clone --depth 1 https://github.com/soulteary/onecloud-u-boot.git
        cd onecloud-u-boot
        
        # åˆ›å»º openwrt ç›®å½•
        mkdir -p openwrt
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ tar.gz æ ¼å¼çš„ rootfs
        if [ -f "$ROOTFS_PATH" ] && [[ "$ROOTFS_PATH" == *.tar.gz ]]; then
          echo "âœ… æ‰¾åˆ° tar.gz æ ¼å¼çš„ rootfsï¼Œç›´æ¥è§£å‹"
          tar -xzf "$ROOTFS_PATH" -C openwrt/
        else
          echo "âš ï¸  æœªæ‰¾åˆ° tar.gz æ ¼å¼ï¼Œéœ€è¦ä»é•œåƒä¸­æå–æ–‡ä»¶ç³»ç»Ÿ"
          
          # æŸ¥æ‰¾ ext4 rootfs é•œåƒ
          EXT4_IMG=$(find $OPENWRT_PATH/bin/targets -name "*ext4-rootfs.img.gz" | head -n 1)
          
          if [ -z "$EXT4_IMG" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å¯ç”¨çš„ rootfs æ–‡ä»¶"
            exit 1
          fi
          
          echo "ä½¿ç”¨ ext4 é•œåƒ: $EXT4_IMG"
          
          # è§£å‹ .img.gz
          gunzip -c "$EXT4_IMG" > rootfs.img
          
          # æŒ‚è½½ ext4 é•œåƒå¹¶å¤åˆ¶æ–‡ä»¶
          echo "æŒ‚è½½é•œåƒå¹¶æå–æ–‡ä»¶ç³»ç»Ÿ..."
          sudo mkdir -p /mnt/rootfs
          sudo mount -o loop rootfs.img /mnt/rootfs
          sudo cp -a /mnt/rootfs/* openwrt/
          sudo umount /mnt/rootfs
          rm -f rootfs.img
          
          echo "âœ… æ–‡ä»¶ç³»ç»Ÿæå–å®Œæˆ"
        fi
        
        # æ£€æŸ¥æå–ç»“æœ
        echo "===== æå–çš„æ–‡ä»¶ç³»ç»Ÿå†…å®¹ ====="
        ls -lh openwrt/ | head -20
        
        echo "PACK_DIR=$GITHUB_WORKSPACE/package" >> $GITHUB_ENV

    - name: ä½¿ç”¨ Docker æ‰“åŒ… OneCloud å›ºä»¶
      if: steps.compile.outputs.status == 'success'
      id: package
      run: |
        cd $PACK_DIR/onecloud-u-boot
        
        # åˆ›å»º openwrt ç›®å½•å¹¶è§£å‹ rootfs
        echo "è§£å‹ rootfs..."
        mkdir -p openwrt
        ROOTFS_FILE=$(ls *rootfs.tar.gz | head -n 1)
        echo "è§£å‹æ–‡ä»¶: $ROOTFS_FILE"
        tar -xzf "$ROOTFS_FILE" -C openwrt/
        
        # æ£€æŸ¥è§£å‹ç»“æœ
        echo "===== è§£å‹åçš„å†…å®¹ ====="
        ls -lh openwrt/ | head -20
        
        # æ‹‰å– soulteary çš„æ‰“åŒ…å·¥å…·é•œåƒ
        echo "æ‹‰å– Docker æ‰“åŒ…å·¥å…·..."
        sudo docker pull soulteary/onecloud-uboot:packer-2025.01.06
        
        # ä½¿ç”¨ Docker è¿›è¡Œæ‰“åŒ…
        echo "å¼€å§‹æ‰“åŒ… OneCloud å›ºä»¶..."
        sudo docker run --rm -v $(pwd):/uboot soulteary/onecloud-uboot:packer-2025.01.06
        
        # æ£€æŸ¥æ‰“åŒ…ç»“æœ
        echo "===== æ‰“åŒ…ç»“æœ ====="
        ls -lh build/ || true
        
        if [ -f "build/eMMC.burn.img" ]; then
          echo "âœ… æ‰“åŒ…æˆåŠŸï¼"
          
          # é‡å‘½åå’Œå‹ç¼©å›ºä»¶
          mkdir -p $GITHUB_WORKSPACE/output
          FIRMWARE_NAME="ImmortalWrt-OneCloud-$(date +%Y%m%d).img"
          cp build/eMMC.burn.img $GITHUB_WORKSPACE/output/$FIRMWARE_NAME
          
          cd $GITHUB_WORKSPACE/output
          
          # ç”Ÿæˆ SHA256 æ ¡éªŒ
          sha256sum $FIRMWARE_NAME > $FIRMWARE_NAME.sha256
          
          # å‹ç¼©å›ºä»¶
          gzip -k $FIRMWARE_NAME
          
          echo "===== æœ€ç»ˆå›ºä»¶ ====="
          ls -lh
          
          echo "FIRMWARE_PATH=$GITHUB_WORKSPACE/output" >> $GITHUB_ENV
          echo "FIRMWARE_NAME=$FIRMWARE_NAME" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ‰“åŒ…å¤±è´¥ï¼šæœªç”Ÿæˆé•œåƒæ–‡ä»¶"
          echo "Docker è¿è¡Œæ—¥å¿—ï¼š"
          sudo docker logs $(sudo docker ps -lq) || true
          exit 1
        fi

    - name: ä¸Šä¼  rootfsï¼ˆå¤‡ä»½ï¼‰
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: ImmortalWrt_Rootfs_${{ env.FILE_DATE }}
        path: ${{ env.ROOTFS_PATH }}

    - name: ä¸Šä¼ æ‰“åŒ…å›ºä»¶
      uses: actions/upload-artifact@v4
      if: steps.package.outputs.status == 'success'
      with:
        name: ImmortalWrt_OneCloud_Firmware_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}/*

    - name: ç”Ÿæˆ Release è¯´æ˜
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.package.outputs.status == 'success'
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        
        cat > release.txt <<EOF
        ## ğŸ‰ ImmortalWrt OneCloud å›ºä»¶
        
        ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
        - **æ„å»ºæ—¶é—´**: $(date +"%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S")
        - **ç›®æ ‡è®¾å¤‡**: ç©å®¢äº‘ OneCloud (Amlogic S805)
        - **ç³»ç»Ÿç‰ˆæœ¬**: ImmortalWrt $REPO_BRANCH
        - **U-Boot**: soulteary/onecloud-uboot (2025.01.06)
        - **å›ºä»¶ç±»å‹**: å®Œæ•´åˆ·æœºåŒ…ï¼ˆ.imgï¼‰
        
        ### âœ¨ å›ºä»¶ç‰¹æ€§
        - âœ… åŸºäº ImmortalWrt æœ€æ–°æºç ç¼–è¯‘
        - âœ… ç²¾ç®€ç³»ç»Ÿï¼Œè¿è¡Œæµç•…
        - âœ… ä¸­æ–‡ç•Œé¢ï¼Œä½¿ç”¨å‹å¥½
        - âœ… åŒ…å« LuCI Web ç®¡ç†ç•Œé¢
        - âœ… æ”¯æŒ USB å­˜å‚¨è®¾å¤‡
        - âœ… åƒå…†æœ‰çº¿ç½‘ç»œ
        
        ### ğŸš€ åˆ·æœºæ–¹æ³•
        
        #### æ–¹æ³•ä¸€ï¼šç³»ç»Ÿå†…å‡çº§ï¼ˆæ¨èï¼‰â­
        å¦‚æœä½ çš„ OneCloud å·²ç»è¿è¡Œ OpenWrt/Armbian ç­‰ Linux ç³»ç»Ÿï¼š
        
        \`\`\`bash
        # SSH ç™»å½•åˆ° OneCloud
        ssh root@ä½ çš„IPåœ°å€
        
        # ä¸‹è½½å›ºä»¶ï¼ˆæ›¿æ¢ä¸‹é¢çš„ URLï¼‰
        cd /tmp
        wget https://github.com/ä½ çš„ç”¨æˆ·å/ä»“åº“/releases/download/${{ steps.tag.outputs.release_tag }}/${{ env.FIRMWARE_NAME }}.gz
        
        # è§£å‹
        gunzip ${{ env.FIRMWARE_NAME }}.gz
        
        # åˆ·å…¥å›ºä»¶ï¼ˆâš ï¸ æ³¨æ„ï¼šä¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ï¼‰
        dd if=${{ env.FIRMWARE_NAME }} of=/dev/mmcblk0 bs=4M conv=fsync status=progress
        
        # é‡å¯
        reboot
        \`\`\`
        
        #### æ–¹æ³•äºŒï¼šUSB çº¿åˆ·ï¼ˆå…¨æ–°å®‰è£…ï¼‰
        
        **å‡†å¤‡å·¥å…·ï¼š**
        - USB åŒå…¬å¤´æ•°æ®çº¿
        - [Amlogic USB Burning Tool v2.1.6.8](https://www.amlogic.cn/)
        - é•Šå­æˆ–é‡‘å±å¯¼çº¿ï¼ˆç”¨äºçŸ­æ¥ï¼‰
        
        **åˆ·æœºæ­¥éª¤ï¼š**
        1. æ‹†å¼€ OneCloud å¤–å£³ï¼Œæ‰¾åˆ°ä¸»æ¿
        2. æ‰¾åˆ°çŸ­æ¥ç‚¹ï¼ˆä¸åŒç‰ˆæœ¬ä½ç½®å¯èƒ½ä¸åŒï¼Œè¯·æœç´¢"ç©å®¢äº‘çŸ­æ¥ç‚¹"ï¼‰
        3. USB çº¿è¿æ¥ OneCloudï¼ˆé è¿‘ HDMI çš„ USB å£ï¼‰å’Œç”µè„‘
        4. æ‰“å¼€ USB Burning Toolï¼Œå¯¼å…¥ä¸‹è½½çš„ \`.img\` æ–‡ä»¶ï¼ˆè§£å‹åï¼‰
        5. ç”¨é•Šå­çŸ­æ¥è§¦ç‚¹ï¼Œç„¶åæ’ç”µï¼Œçœ‹åˆ°"å·²è¿æ¥"åæ¾å¼€
        6. ç‚¹å‡»"å¼€å§‹"æŒ‰é’®ï¼Œç­‰å¾…åˆ·å†™å®Œæˆï¼ˆçº¦ 5-6 åˆ†é’Ÿï¼‰
        7. åˆ·å†™æˆåŠŸåæ–­ç”µï¼Œè£…å›å¤–å£³
        
        ### âš™ï¸ é¦–æ¬¡ä½¿ç”¨
        
        1. **è¿æ¥è®¾å¤‡**
           - ç”¨ç½‘çº¿è¿æ¥ OneCloud å’Œè·¯ç”±å™¨
           - æ’ç”µå¯åŠ¨ï¼Œç­‰å¾… 2-3 åˆ†é’Ÿ
        
        2. **æŸ¥æ‰¾ IP åœ°å€**
           - æ–¹æ³• 1ï¼šç™»å½•è·¯ç”±å™¨åå°ï¼ŒæŸ¥çœ‹åä¸º "ImmortalWrt" çš„è®¾å¤‡
           - æ–¹æ³• 2ï¼šä½¿ç”¨ IP æ‰«æå·¥å…·æ‰«æå±€åŸŸç½‘
        
        3. **ç™»å½•ç®¡ç†ç•Œé¢**
           - æµè§ˆå™¨è®¿é—®ï¼š\`http://ä½ çš„IPåœ°å€\`
           - é»˜è®¤ç”¨æˆ·åï¼š\`root\`
           - é»˜è®¤å¯†ç ï¼š\`password\` æˆ–æ— å¯†ç 
        
        4. **é¦–æ¬¡é…ç½®**
           - ä¿®æ”¹ç®¡ç†å¯†ç ï¼ˆé‡è¦ï¼ï¼‰
           - é…ç½®ç½‘ç»œï¼ˆWAN/LANï¼‰
           - æ ¹æ®éœ€è¦å®‰è£…é¢å¤–è½¯ä»¶åŒ…
        
        ### ğŸ“‚ æ–‡ä»¶è¯´æ˜
        
        - **${{ env.FIRMWARE_NAME }}.gz** - å‹ç¼©çš„å›ºä»¶é•œåƒï¼ˆæ¨èä¸‹è½½ï¼Œä½“ç§¯å°ï¼‰
        - **${{ env.FIRMWARE_NAME }}** - æœªå‹ç¼©çš„å›ºä»¶é•œåƒ
        - **${{ env.FIRMWARE_NAME }}.sha256** - SHA256 æ ¡éªŒæ–‡ä»¶
        - **rootfs.tar.gz** - æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾›é«˜çº§ç”¨æˆ·è‡ªè¡Œæ‰“åŒ…ä½¿ç”¨ï¼‰
        
        ### âš ï¸ é‡è¦æé†’
        
        - åˆ·æœºå‰è¯·**åŠ¡å¿…å¤‡ä»½**é‡è¦æ•°æ®å’Œé…ç½®
        - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ 2-3 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…
        - å¦‚é‡é—®é¢˜ï¼Œå¯å°è¯•é‡æ–°åˆ·æœºæˆ–ä½¿ç”¨ USB çº¿åˆ·æ–¹å¼
        - å»ºè®®é¦–æ¬¡ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç 
        - ä¸‹è½½åè¯·éªŒè¯ SHA256 æ ¡éªŒå€¼
        
        ### ğŸ”§ æ•…éšœæ’æŸ¥
        
        **æ— æ³•è®¿é—®ç®¡ç†ç•Œé¢ï¼Ÿ**
        - æ£€æŸ¥ç½‘çº¿è¿æ¥
        - æŸ¥çœ‹è·¯ç”±å™¨ DHCP åˆ—è¡¨ç¡®è®¤ IP
        - ç­‰å¾…è¶³å¤Ÿçš„å¯åŠ¨æ—¶é—´ï¼ˆ2-3åˆ†é’Ÿï¼‰
        - æ£€æŸ¥è®¾å¤‡æŒ‡ç¤ºç¯çŠ¶æ€
        
        **åˆ·æœºå¤±è´¥ï¼Ÿ**
        - ç¡®è®¤ä½¿ç”¨ USB Burning Tool v2.1.6.8
        - æ£€æŸ¥çŸ­æ¥æ˜¯å¦åˆ°ä½
        - æ›´æ¢ USB çº¿æˆ–ç”µè„‘ USB å£
        - ç¡®ä¿ä¸‹è½½çš„å›ºä»¶å®Œæ•´ï¼ˆæ£€æŸ¥ SHA256ï¼‰
        - å°è¯•ä½¿ç”¨è§£å‹åçš„ .img æ–‡ä»¶
        
        ### ğŸ’¡ è¿›é˜¶ä½¿ç”¨
        
        **ç£ç›˜æ‰©å®¹ï¼ˆä½¿ç”¨å…¨éƒ¨ eMMC ç©ºé—´ï¼‰ï¼š**
        \`\`\`bash
        ssh root@ä½ çš„IP
        /usr/sbin/parted /dev/mmcblk0 resizepart 2 100%
        resize2fs /dev/mmcblk0p2
        df -h  # æŸ¥çœ‹æ‰©å®¹ç»“æœ
        \`\`\`
        
        **æŒ‚è½½ USB å­˜å‚¨ï¼š**
        \`\`\`bash
        # æŸ¥çœ‹è®¾å¤‡
        fdisk -l
        
        # æŒ‚è½½ï¼ˆå‡è®¾æ˜¯ /dev/sda1ï¼‰
        mkdir -p /mnt/usb
        mount /dev/sda1 /mnt/usb
        
        # å¼€æœºè‡ªåŠ¨æŒ‚è½½ï¼ˆç¼–è¾‘ /etc/fstabï¼‰
        echo "/dev/sda1 /mnt/usb ext4 defaults 0 0" >> /etc/fstab
        \`\`\`
        
        ### ğŸ“ åé¦ˆä¸æ”¯æŒ
        
        å¦‚é‡é—®é¢˜æˆ–æœ‰å»ºè®®ï¼Œæ¬¢è¿åœ¨ Issues ä¸­åé¦ˆï¼
        
        ---
        
        **æ„Ÿè°¢ä½¿ç”¨ï¼å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œè¯·ç»™ä¸ª â­ Starï¼**
        EOF
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          ${{ env.FIRMWARE_PATH }}/*

    - name: æ¸…ç†æ—§çš„ Releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      if: env.UPLOAD_RELEASE == 'true' && steps.tag.outputs.status == 'success'
      with:
        keep_latest: 5
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: Build_Logs_${{ env.FILE_DATE || 'failed' }}
        path: |
          ${{ github.workspace }}/openwrt/build.log
          ${{ github.workspace }}/openwrt/.config
        if-no-files-found: ignore
