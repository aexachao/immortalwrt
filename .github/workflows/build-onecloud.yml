name: Build ImmortalWrt for OneCloud (Kwrt Style)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 初始化编译环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-dev python3-setuptools rsync unzip zlib1g-dev file wget \
          libelf-dev cmake gzip bzip2 patch perl-base
        sudo timedatectl set-timezone "$TZ"

    - name: 克隆源代码
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

    - name: 更新 feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 加载 ARMv7 通用配置（用于生成 rootfs）
      run: |
        cd $OPENWRT_PATH
        
        # 使用通用 ARMv7 目标编译 rootfs
        cat > .config <<EOF
        # 通用 ARMv7 目标
        CONFIG_TARGET_armsr=y
        CONFIG_TARGET_armsr_armv7=y
        CONFIG_TARGET_MULTI_PROFILE=y
        CONFIG_TARGET_DEVICE_armsr_armv7_DEVICE_generic=y
        
        # 生成 rootfs.tar.gz（重要！）
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        CONFIG_TARGET_KERNEL_PARTSIZE=32
        CONFIG_TARGET_ROOTFS_PARTSIZE=800
        
        # 基础系统（精简）
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        
        # 核心应用
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        
        # 禁用 Python（避免依赖问题）
        # CONFIG_PACKAGE_python3 is not set
        
        # USB 支持
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        
        EOF
        
        make defconfig

    - name: 下载编译依赖
      run: |
        cd $OPENWRT_PATH
        make download -j16

    - name: 编译固件
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo "开始编译（$(nproc) 线程）..."
        make -j$(nproc) V=s 2>&1 | tee build.log || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: 下载 OneCloud 打包工具
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH
        # 使用 unifreq 的打包脚本（支持 S805）
        git clone --depth 1 https://github.com/unifreq/openwrt_packit package/openwrt_packit
        
        # 或使用 shiyu1314 的脚本
        # git clone --depth 1 https://github.com/shiyu1314/OneCloud-OpenWrt-Build package/onecloud_build

    - name: 打包 OneCloud 固件
      id: package
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH
        
        # 查找 rootfs.tar.gz
        ROOTFS_FILE=$(find bin/targets -name "*rootfs.tar.gz" | head -n 1)
        echo "找到 rootfs: $ROOTFS_FILE"
        
        if [ -z "$ROOTFS_FILE" ]; then
          echo "错误：未找到 rootfs.tar.gz"
          exit 1
        fi
        
        # 复制到打包目录
        mkdir -p package/openwrt_packit/tmp
        cp $ROOTFS_FILE package/openwrt_packit/tmp/
        
        # 进入打包目录
        cd package/openwrt_packit
        
        # 使用打包脚本（根据实际脚本名称调整）
        # 如果有 mk_s805_mxqpro+.sh 或类似脚本
        if [ -f "mk_s805_mxqpro+.sh" ]; then
          sudo bash mk_s805_mxqpro+.sh
        elif [ -f "make.sh" ]; then
          sudo bash make.sh -d
        else
          echo "警告：未找到打包脚本，尝试手动打包..."
          # 这里需要根据实际的打包脚本调整
        fi
        
        # 整理固件
        mkdir -p $OPENWRT_PATH/output
        find . -name "*.img" -o -name "*.img.gz" | xargs -i cp {} $OPENWRT_PATH/output/ || true
        
        echo "FIRMWARE_PATH=$OPENWRT_PATH/output" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        # 显示打包结果
        echo "===== 打包完成的固件 ====="
        ls -lh $OPENWRT_PATH/output/

    - name: 上传原始 rootfs（备用）
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: ImmortalWrt_OneCloud_Rootfs_${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin/targets/*/*/*.tar.gz

    - name: 上传打包固件
      uses: actions/upload-artifact@v4
      if: steps.package.outputs.status == 'success'
      with:
        name: ImmortalWrt_OneCloud_Firmware_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: 生成 Release
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.package.outputs.status == 'success'
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        cat > release.txt <<EOF
        ## ImmortalWrt OneCloud (S805) 固件
        
        ### 编译信息
        - 编译时间: $(date +"%Y年%m月%d日 %H:%M:%S")
        - 目标设备: OneCloud (Amlogic S805)
        - 内核版本: ARMv7 通用
        
        ### 刷机方法
        1. 下载 .img 或 .img.gz 文件
        2. 解压（如果是 .gz）
        3. SSH 到 OneCloud 执行:
           \`\`\`
           dd if=/tmp/固件.img of=/dev/mmcblk0 bs=4M conv=fsync
           reboot
           \`\`\`
        
        ### 默认设置
        - IP: 192.168.1.1 或 DHCP
        - 用户名: root
        - 密码: password 或无密码
        EOF
        echo "status=success" >> $GITHUB_OUTPUT

    - name: 上传到 Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          ${{ env.FIRMWARE_PATH }}/*
          ${{ env.OPENWRT_PATH }}/bin/targets/*/*/*.tar.gz

    - name: 上传编译日志（如果失败）
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: Build_Log_${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/build.log
