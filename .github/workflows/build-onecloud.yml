name: Build ImmortalWrt for OneCloud S805

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-dev python3-setuptools python3-pip \
          rsync unzip zlib1g-dev file wget libelf-dev cmake
        sudo timedatectl set-timezone "$TZ"

    - name: å…‹éš†æºä»£ç 
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

    - name: æ›´æ–° feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åŠ è½½ OneCloud S805 é…ç½®
      run: |
        cd $OPENWRT_PATH
        
        # åˆ›å»ºç²¾ç®€çš„ OneCloud é…ç½®
        cat > .config <<EOF
        # Target è®¾ç½®ï¼ˆå°è¯•ä½¿ç”¨ ARMv7 é€šç”¨ç›®æ ‡ï¼‰
        CONFIG_TARGET_armsr=y
        CONFIG_TARGET_armsr_armv7=y
        CONFIG_TARGET_MULTI_PROFILE=y
        CONFIG_TARGET_DEVICE_armsr_armv7_DEVICE_generic=y
        
        # åŸºç¡€ç³»ç»Ÿ
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        
        # æ ¸å¿ƒåŠŸèƒ½ï¼ˆç²¾ç®€ç‰ˆï¼‰
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        
        # ç¦ç”¨ Python ç›¸å…³åŒ…ï¼ˆé¿å…ä¾èµ–é—®é¢˜ï¼‰
        # CONFIG_PACKAGE_python3 is not set
        # CONFIG_PACKAGE_python3-base is not set
        
        # å¯é€‰æ’ä»¶ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
        # CONFIG_PACKAGE_luci-app-samba4=y
        # CONFIG_PACKAGE_luci-app-ddns=y
        # CONFIG_PACKAGE_luci-app-upnp=y
        
        # é•œåƒæ ¼å¼ï¼ˆç”Ÿæˆ tar.gz ç”¨äºŽåŽç»­æ‰“åŒ…ï¼‰
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_TARGET_ROOTFS_EXT4FS=y
        
        # å†…æ ¸æ¨¡å—
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        
        EOF
        
        make defconfig
        
        # æ˜¾ç¤ºæœ€ç»ˆé…ç½®
        echo "===== æœ€ç»ˆé…ç½®é¢„è§ˆ ====="
        grep "^CONFIG_TARGET" .config | head -20

    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
        make download -j16
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹è½½å¤±è´¥çš„åŒ…
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨ $(nproc) çº¿ç¨‹ï¼‰..."
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # å…ˆå°è¯•å¤šçº¿ç¨‹ç¼–è¯‘
        make -j$(nproc) V=s 2>&1 | tee build.log || {
          echo "å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å•çº¿ç¨‹æ¨¡å¼..."
          make -j1 V=s 2>&1 | tee -a build.log
        }
        
        echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
    
    - name: æ£€æŸ¥ç¼–è¯‘ç»“æžœ
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH
        echo "===== ç¼–è¯‘è¾“å‡ºæ–‡ä»¶ ====="
        ls -lh bin/targets/*/* 2>/dev/null || echo "æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡º"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
        if grep -i "error" build.log | grep -v "WARNING" | tail -20; then
          echo "å‘çŽ°ç¼–è¯‘é”™è¯¯ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æ—¥å¿—"
        fi

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        ls -lh

    - name: ä¸Šä¼ å›ºä»¶åˆ° Artifacts
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: ImmortalWrt_OneCloud_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: ç”Ÿæˆ Release Tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true'
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "## ImmortalWrt OneCloud S805 å›ºä»¶" >> release.txt
        echo "### ç¼–è¯‘æ—¶é—´" >> release.txt
        echo "ðŸ• $(date +"%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S")" >> release.txt
        echo "### ä½¿ç”¨è¯´æ˜Ž" >> release.txt
        echo "1. ä¸‹è½½ rootfs.tar.gz æ–‡ä»¶" >> release.txt
        echo "2. ä½¿ç”¨æ‰“åŒ…å·¥å…·ç”Ÿæˆ OneCloud å¯åˆ·å†™é•œåƒ" >> release.txt
        echo "3. æˆ–ç›´æŽ¥SSHå‡çº§æ›¿æ¢æ ¹æ–‡ä»¶ç³»ç»Ÿ" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ° Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE_PATH }}/*
