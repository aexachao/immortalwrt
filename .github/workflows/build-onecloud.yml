name: Build ImmortalWrt for OneCloud (Full Package)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * 0'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
          python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev dosfstools mtools parted
        sudo timedatectl set-timezone "$TZ"

    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

    - name: æ›´æ–° feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åŠ è½½é…ç½®ï¼ˆARMv7 é€šç”¨ï¼‰
      run: |
        cd $OPENWRT_PATH
        
        cat > .config <<EOF
        CONFIG_TARGET_armsr=y
        CONFIG_TARGET_armsr_armv7=y
        CONFIG_TARGET_MULTI_PROFILE=y
        CONFIG_TARGET_DEVICE_armsr_armv7_DEVICE_generic=y
        
        # ç”Ÿæˆ rootfs.tar.gzï¼ˆå…³é”®ï¼ï¼‰
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_TARGET_ROOTFS_PARTSIZE=960
        
        # åŸºç¡€ç³»ç»Ÿ
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        
        # æ ¸å¿ƒåº”ç”¨
        CONFIG_PACKAGE_luci-app-opkg=y
        CONFIG_PACKAGE_luci-app-firewall=y
        CONFIG_PACKAGE_luci-app-ttyd=y
        
        # USB å’Œæ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        CONFIG_PACKAGE_kmod-usb-storage-extras=y
        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y
        
        # ç½‘ç»œå·¥å…·
        CONFIG_PACKAGE_wget-ssl=y
        CONFIG_PACKAGE_curl=y
        
        # æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–æ’ä»¶
        # CONFIG_PACKAGE_luci-app-samba4=y
        # CONFIG_PACKAGE_luci-app-ddns=y
        
        EOF
        
        make defconfig

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd $OPENWRT_PATH
        make download -j16

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ç¼–è¯‘ ImmortalWrt..."
        make -j$(nproc) V=s || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: å‡†å¤‡æ‰“åŒ…çŽ¯å¢ƒ
      if: steps.compile.outputs.status == 'success'
      run: |
        # åˆ›å»ºæ‰“åŒ…ç›®å½•
        mkdir -p $GITHUB_WORKSPACE/package_workspace
        cd $GITHUB_WORKSPACE/package_workspace
        
        # å…‹éš† OneCloud u-boot é¡¹ç›®
        git clone --depth 1 https://github.com/soulteary/onecloud-u-boot.git
        
        # å…‹éš†æ‰“åŒ…è„šæœ¬ï¼ˆä½¿ç”¨ç¤¾åŒºå¸¸ç”¨çš„å·¥å…·ï¼‰
        git clone --depth 1 https://github.com/hzyitc/u-boot-onecloud.git pack-tools
        
        echo "PACK_WORKSPACE=$GITHUB_WORKSPACE/package_workspace" >> $GITHUB_ENV

    - name: æ‰“åŒ… OneCloud å›ºä»¶
      id: package
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $PACK_WORKSPACE
        
        # æŸ¥æ‰¾ rootfs
        ROOTFS_FILE=$(find $OPENWRT_PATH/bin/targets -name "*rootfs.tar.gz" | head -n 1)
        
        if [ -z "$ROOTFS_FILE" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° rootfs.tar.gz"
          exit 1
        fi
        
        echo "æ‰¾åˆ° rootfs: $ROOTFS_FILE"
        
        # åˆ›å»ºæ‰“åŒ…ç›®å½•ç»“æž„
        mkdir -p output
        mkdir -p build
        
        # å¤åˆ¶ rootfs
        cp $ROOTFS_FILE build/rootfs.tar.gz
        
        # ä½¿ç”¨ u-boot æ‰“åŒ…å·¥å…·ï¼ˆéœ€è¦æ ¹æ®å®žé™…å·¥å…·è°ƒæ•´ï¼‰
        # å¦‚æžœæœ‰çŽ°æˆçš„æ‰“åŒ…è„šæœ¬
        if [ -f "pack-tools/make_img.sh" ]; then
          cd pack-tools
          sudo bash make_img.sh ../build/rootfs.tar.gz
          cp *.img ../output/ || true
        else
          # æ‰‹åŠ¨æ‰“åŒ…æµç¨‹
          cd $PACK_WORKSPACE
          
          # ä¸‹è½½ OneCloud u-boot
          if [ ! -f "onecloud-u-boot/pack/bootloader.img" ]; then
            echo "u-boot æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ ä»Ž release ä¸‹è½½é¢„ç¼–è¯‘ u-boot çš„é€»è¾‘
          fi
          
          # åˆ›å»ºé•œåƒ
          echo "åˆ›å»º OneCloud é•œåƒ..."
          
          # åŸºæœ¬çš„é•œåƒåˆ›å»ºæµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
          IMG_SIZE=1024  # 1GB
          IMG_NAME="immortalwrt-onecloud-$(date +%Y%m%d).img"
          
          # åˆ›å»ºç©ºé•œåƒ
          dd if=/dev/zero of=output/$IMG_NAME bs=1M count=$IMG_SIZE
          
          # åˆ›å»ºåˆ†åŒºè¡¨
          parted -s output/$IMG_NAME mklabel msdos
          parted -s output/$IMG_NAME mkpart primary ext4 17M 100%
          
          # æŒ‚è½½å¹¶å†™å…¥ rootfs
          LOOP_DEV=$(sudo losetup -f --show output/$IMG_NAME)
          sudo partprobe $LOOP_DEV
          
          # æ ¼å¼åŒ–åˆ†åŒº
          sudo mkfs.ext4 -F ${LOOP_DEV}p1
          
          # æŒ‚è½½åˆ†åŒº
          MOUNT_DIR=$(mktemp -d)
          sudo mount ${LOOP_DEV}p1 $MOUNT_DIR
          
          # è§£åŽ‹ rootfs
          sudo tar -xzf build/rootfs.tar.gz -C $MOUNT_DIR
          
          # å¸è½½
          sudo umount $MOUNT_DIR
          sudo losetup -d $LOOP_DEV
          rmdir $MOUNT_DIR
          
          echo "åŸºç¡€é•œåƒåˆ›å»ºå®Œæˆ"
        fi
        
        # åŽ‹ç¼©é•œåƒ
        cd output
        for img in *.img; do
          if [ -f "$img" ]; then
            echo "åŽ‹ç¼© $img ..."
            gzip -k "$img"
          fi
        done
        
        echo "FIRMWARE_PATH=$PACK_WORKSPACE/output" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        echo "===== æ‰“åŒ…å®Œæˆ ====="
        ls -lh $PACK_WORKSPACE/output/

    - name: ä¸Šä¼  rootfsï¼ˆå¤‡ç”¨ï¼‰
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success'
      with:
        name: ImmortalWrt_OneCloud_Rootfs_${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin/targets/*/*/immortalwrt-*-rootfs.tar.gz

    - name: ä¸Šä¼ æ‰“åŒ…å›ºä»¶
      uses: actions/upload-artifact@v4
      if: steps.package.outputs.status == 'success'
      with:
        name: ImmortalWrt_OneCloud_Firmware_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: ç”Ÿæˆ Release è¯´æ˜Ž
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.package.outputs.status == 'success'
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        cat > release.txt <<EOF
        ## ImmortalWrt OneCloud (S805) å›ºä»¶
        
        ### ðŸ“¦ ç¼–è¯‘ä¿¡æ¯
        - ç¼–è¯‘æ—¶é—´: $(date +"%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S")
        - ç›®æ ‡è®¾å¤‡: OneCloud (Amlogic S805)
        - åŸºäºŽ: ImmortalWrt $REPO_BRANCH åˆ†æ”¯
        - U-Boot: soulteary/onecloud-u-boot
        
        ### ðŸ“ å›ºä»¶è¯´æ˜Ž
        æ­¤å›ºä»¶ç»è¿‡å®Œæ•´çš„ç¼–è¯‘å’Œæ‰“åŒ…æµç¨‹ï¼ŒåŒ…å«ï¼š
        - âœ… OneCloud ä¸“ç”¨ u-boot
        - âœ… ImmortalWrt ç³»ç»Ÿï¼ˆç²¾ç®€ç‰ˆï¼‰
        - âœ… ä¸­æ–‡ç•Œé¢
        - âœ… åŸºç¡€ç½‘ç»œåŠŸèƒ½
        
        ### ðŸš€ åˆ·æœºæ–¹æ³•
        
        **æ–¹æ³• 1: ç³»ç»Ÿå†…å‡çº§ï¼ˆæŽ¨èï¼‰**
        \`\`\`bash
        # SSH ç™»å½•åˆ° OneCloud
        ssh root@ä½ çš„IP
        
        # ä¸‹è½½å›ºä»¶
        cd /tmp
        wget https://github.com/ä½ çš„ç”¨æˆ·å/ä»“åº“/releases/download/${{ steps.tag.outputs.release_tag }}/å›ºä»¶æ–‡ä»¶å.img.gz
        
        # è§£åŽ‹
        gunzip *.img.gz
        
        # åˆ·å…¥ï¼ˆâš ï¸ ä¼šæ¸…ç©ºæ•°æ®ï¼‰
        dd if=*.img of=/dev/mmcblk0 bs=4M conv=fsync status=progress
        
        # é‡å¯
        reboot
        \`\`\`
        
        **æ–¹æ³• 2: USB åˆ·æœº**
        1. ä½¿ç”¨ USB åŒå…¬å¤´çº¿è¿žæŽ¥ OneCloud å’Œç”µè„‘
        2. æŒ‰ä½ Reset å­”æ’ç”µè¿›å…¥åˆ·æœºæ¨¡å¼
        3. ä½¿ç”¨ USB Burning Tool åˆ·å…¥å›ºä»¶
        
        ### âš™ï¸ é»˜è®¤è®¾ç½®
        - IP åœ°å€: \`192.168.1.1\` æˆ– DHCP è‡ªåŠ¨èŽ·å–
        - ç”¨æˆ·å: \`root\`
        - å¯†ç : \`password\`ï¼ˆæˆ–æ— å¯†ç ï¼‰
        
        ### âš ï¸ æ³¨æ„äº‹é¡¹
        - åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦æ•°æ®
        - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ 2-3 åˆ†é’Ÿ
        - å»ºè®®é¦–æ¬¡ç™»å½•åŽä¿®æ”¹å¯†ç 
        - å¦‚éœ€æ‰©å®¹ï¼Œç™»å½•åŽæ‰§è¡Œç£ç›˜æ‰©å®¹æ“ä½œ
        
        ### ðŸ“‚ æ–‡ä»¶è¯´æ˜Ž
        - \`.img.gz\`: åŽ‹ç¼©çš„å›ºä»¶é•œåƒï¼ˆæŽ¨èä¸‹è½½ï¼‰
        - \`.img\`: æœªåŽ‹ç¼©çš„å›ºä»¶é•œåƒ
        - \`rootfs.tar.gz\`: æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾›é«˜çº§ç”¨æˆ·ä½¿ç”¨ï¼‰
        EOF
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          ${{ env.FIRMWARE_PATH }}/*
          ${{ env.OPENWRT_PATH }}/bin/targets/*/*/immortalwrt-*-rootfs.tar.gz

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: Build_Error_Log_${{ env.FILE_DATE }}
        path: |
          ${{ env.OPENWRT_PATH }}/build.log
          ${{ env.OPENWRT_PATH }}/.config
